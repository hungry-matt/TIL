# 내장 웹 서버 이해

스프링 부트는 내장 서블릿 프레임워크를 쉽게 사용할 수 있게 해주는 툴이며 웹 서버가 아니다.

- spring-boot-starter-web 의존성을 사용하면 기본적으로 톰캣이 내장되어 있다.

```xml
spring-boot-starter-web-{version}.pom

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-tomcat</artifactId>
    <version>2.0.3.RELEASE</version>
    <scope>compile</scope>
</dependency>
```

```xml
spring-boot-starter-tomcat-{version}.pom

<dependency>
    <groupId>org.apache.tomcat.embed</groupId>
    <artifactId>tomcat-embed-core</artifactId>
    <version>8.5.31</version>
    <scope>compile</scope>
    <exclusions>
    <exclusion>
        <artifactId>tomcat-annotations-api</artifactId>
        <groupId>org.apache.tomcat</groupId>
    </exclusion>
    </exclusions>
</dependency>

<dependency>
    <groupId>org.apache.tomcat.embed</groupId>
    <artifactId>tomcat-embed-websocket</artifactId>
    <version>8.5.31</version>
    <scope>compile</scope>
</dependency>
```

> 톰캣은 데이터를 동적으로 처리하기 위한 서블릿 컨테이너로 HTTP 요청과 응답 등을 처리한다.

Java로 톰캣을 다음과 같이 구현해본다.

```java
public static void main(String[] args) {
    Tomcat tomcat = new Tomcat(); // 톰캣 객체 생성
    tomcat.setPort(8080); // 포트 설정

    try {
        final String docBase = Files.createTmepDirectory("tomcat-tempdir").toString(); // 임시 디렉토리 생성
    } catch (IOException e) {
        e.printStackTrace();
    }
    
    Context context = tomcat.addContext("/", docBase); // 컨텍스트 추가

    //서블릿 객체 생성
    HttpServlet servlet = new HttpServlet() {
        @Override
        prodected void doGet(HtttpServletRequest req, HttpServletResponse resp) throw ServletException, IOException {
            PrintWriter wirter = resp.getWriter();
            writer.println("<html><head><title>");
            writer.println("Hey, Tomcat");
            writer.println("</title></head>");
            writer.println("<body><h1>Hello, Tomcat</h1></body>");
            writer.println("</html>");
        }
    }

    final String servletName = "helloServlet";

    tomcat.addServlet("/", serveltName, servlet); // 톰캣에 서블릿 등록
    
    // 어떤 요청이 오면 서블릿을 보여줄지 매핑하는 과정
    context.addServletMappingDecoded("/hello", servletName); // 컨텍스트에 서블릿 매핑

    try {
        tomcat.start(); // 톰캣 실행
        tomcat.getServer().await(); // 톰캣 실행 후 대기
    } catch (LifecyleException e) {
        e.printStackTrace();
    }
}
```

이렇게 톰캣에 서블릿을 등록하고 실행하는 과정을 스프링 부트에서 자동으로 관리해 주고 있으며 spring.factories 파일안에 설정이 정의 되어있다.

```yml
org.springframework.boot.autoconfigure.web.servlet.ServletWebServerFactoryAutoConfiguration,\
org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration,\
```

## ServletWebServerFactoryAutoConfiguration

Servlet 웹 서버를 자동으로 설정해주며 Tomcat 외에도 Jetty, Undertow도 import 하고 있다.

```java
@Configuration
@AutoConfigureOrder(-2147483648)
@ConditionalOnClass({ServletRequest.class})
@ConditionalOnWebApplication(
    type = Type.SERVLET
)
@EnableConfigurationProperties({ServerProperties.class})
@Import({ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar.class, EmbeddedTomcat.class, EmbeddedJetty.class, EmbeddedUndertow.class})
public class ServletWebServerFactoryAutoConfiguration {
    ...
}
```

EmbeddedTomcat.class

```java
@Configuration
@ConditionalOnClass({Servlet.class, Tomcat.class, UpgradeProtocol.class})
@ConditionalOnMissingBean(
    value = {ServletWebServerFactory.class},
    search = SearchStrategy.CURRENT
)
public static class EmbeddedTomcat {
    public EmbeddedTomcat() {
    }

    @Bean
    public TomcatServletWebServerFactory tomcatServletWebServerFactory() {
        return new TomcatServletWebServerFactory();
    }
}
```

TomcatServletWebServerFactory.class를 보면 다음과 같이 자동 설정으로 톰캣이 생성되는걸 알 수 있다.

```java
public WebServer getWebServer(ServletContextInitializer... initializers) {
    Tomcat tomcat = new Tomcat();
    File baseDir = this.baseDirectory != null ? this.baseDirectory : this.createTempDir("tomcat");
    tomcat.setBaseDir(baseDir.getAbsolutePath());
    Connector connector = new Connector(this.protocol);
    tomcat.getService().addConnector(connector);
    this.customizeConnector(connector);
    tomcat.setConnector(connector);
    tomcat.getHost().setAutoDeploy(false);
    this.configureEngine(tomcat.getEngine());
    Iterator var5 = this.additionalTomcatConnectors.iterator();

    while(var5.hasNext()) {
        Connector additionalConnector = (Connector)var5.next();
        tomcat.getService().addConnector(additionalConnector);
    }

    this.prepareContext(tomcat.getHost(), initializers);
    return this.getTomcatWebServer(tomcat);
}
```

## DispatcherServletAutoConfiguration

HttpServlet을 상속해서 만들어진 클래스이며 스프링의 MVC의 핵심 클래스이다.

서블릿을 만들고 등록하는 역할을 하고 있다.

# 내장 웹 서버 응용

스프링 부트에서 서블릿 기반의 웹 애플리케이션을 만들때 기본적으로 톰캣을 사용하고 있다.

이 밖에 다른 컨테이너를 사용해야할 때 변경 하는 방법을 알아본다.

## Reference
- [Use Another Web Server](https://docs.spring.io/spring-boot/docs/current/reference/html/howto.html#howto.webserver)

## 내장 웹 서버 변경

먼저 spring-boot-starter-web에 기본적으로 포함되어 있는 Tomcat을 exclusions 태그로 제외 시키고 undertow를 추가한다.

```xml
pom.xml

<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
        <exclusions>
            <exclusion>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-starter-tomcat</artifactId>
            </exclusion>
        </exclusions>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-undertow</artifactId>
    </dependency>
</dependencies>
```

애플리케이션을 실행 후 로그를 다음과 같이 확인할 수 있다.

```log
2021-05-31 20:17:46.382  INFO 57948 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/webjars/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2021-05-31 20:17:46.382  INFO 57948 --- [           main] o.s.w.s.handler.SimpleUrlHandlerMapping  : Mapped URL path [/**] onto handler of type [class org.springframework.web.servlet.resource.ResourceHttpRequestHandler]
2021-05-31 20:17:46.610  INFO 57948 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2021-05-31 20:17:46.708  INFO 57948 --- [           main] o.s.b.w.e.u.UndertowServletWebServer     : Undertow started on port(s) 8080 (http) with context path ''
8080
2021-05-31 20:17:46.714  INFO 57948 --- [           main] com.example.Application                  : Started Application in 4.85 seconds (JVM running for 5.65)
```

## 웹 서버 비활성화

스프링 부트는 서블릿 컨테이너가 등록되어 있으면 자동으로 웹 애플리케이션으로 실행된다.

이 동작을 비활성화 하려면 `application.properties`에서 WebApplicationType을 none으로 추가해준다.

그러면 서블릿 컨테이너가 클래스 패스에 있어도 비활성화 시켜준다.

```properties
spring.main.web-application-type=none
```

## 웹 서버 포트 변경

HTTP 포트는 기본적으로 8080이지만 `application.properties`에서 server.port로 변경할 수 있다.

```properties
server.port=7070
```

충돌을 방지하기 위해 사용 가능한 포트를 검색하여 랜덤 포트를 설정할 수 있다.

```properties
server.port=0
```

ApplicationListener 구현하여 정상적으로 적용되었는지 확인한다.

ServletWebServerInitializedEvent의 onApplicationEvent 메서드는 애플리케이션 실행 후 호출되는 콜백 메서드이다.

```java
@Component
public class PortListener implements ApplicationListener<ServletWebServerInitializedEvent> {
    @Override
    public void onApplicationEvent(ServletWebServerInitializedEvent servletWebServerInitializedEvent) {
        ServletWebServerApplicationContext applicationContext = servletWebServerInitializedEvent.getApplicationContext();
        System.out.println("port:" + applicationContext.getWebServer().getPort());
    }
}
```

```log
2021-05-31 20:34:52.995  INFO 54484 --- [           main] o.s.j.e.a.AnnotationMBeanExporter        : Registering beans for JMX exposure on startup
2021-05-31 20:34:53.085  INFO 54484 --- [           main] o.s.b.w.e.u.UndertowServletWebServer     : Undertow started on port(s) 56700 (http) with context path ''
port:56700
2021-05-31 20:34:53.090  INFO 54484 --- [           main] com.example.Application                  : Started Application in 4.572 seconds (JVM running for 5.369)
```