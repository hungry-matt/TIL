# 배포 자동화
## CI & CD
- 버전 관리 시스템(Git, SVN)으로 PUSH 할 경우 자동으로 빌드와 테스트를 수행하여 안정적인 배포 파일을 만드는 과정을 CI(Continuous Intergration)라 한다. 

- 이 빌드 결과물을 가지고 자동으로 운영 서버에 무중단 배포까지 수행하는 과정을 CD(Continuous Deployment)라 한다.

- 일반적으로 CI만 구축되어 있지 않고, CD도 함께 구축되는 경우가 대부분이다.

## Travis CI 연동
Travis는 깃허브에서 제공하는 무료 CI 서비스이다.

### 웹 서비스 설정

- [Travis CI](https://travis-ci.com/) 에서 깃허브 계정으로 로그인 한뒤 오른쪽 상단에 있는 계정 -> Settigs를 선택한다.

- 다음과 같이 프로젝트를 활성화 시켜주면 Travis CI에서의 설정은 끝이며 상세한 설정은 프로젝트의 yml 파일로 진행한다.

![image](https://user-images.githubusercontent.com/45548349/117573937-ad02bf00-b115-11eb-9db4-1381d1250393.png)

### 프로젝트 설정

- Travis CI의 상세한 설정은 프로젝트내 .travis.yml(YAML) 파일로 진행한다.

> YAML :
> YAML은 쉽게 말해 JSON에서 괄호를 제거한 것이다. YAML의 이념이 "기계에서 파싱하기 쉽게, 사람이 다루게 쉽게"이다 보니 익숙하지 않아도 쉽게 다룰수 있다.

- yml 파일은 다음과 같이 작성한다.

```yml
language: java
jdk:
  - openjdk8

#1
branches:
  only:
    - master

# Travis CI 서버의 Home
#2
cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.gradle'

#3
script: "./gradlew clean build"

before_install:
    - chmod +x gradlew

# CI 실행 완료 시 메일로 알람
#4
notifications:
  email:
    recipients:
      - 이메일
```

> #1 branches:
> - Travis CI가 어느 브랜치가 푸쉬 되었을때 수행할지 지정한다.
> - 현재 옵션은 오직 master 브랜치가 푸쉬 되었을 때 수행하게 지정하였다.

> #2 cache:
> - 그레이들을 통해 의존성을 받게 되면 이를 해당 디렉토리에 캐시하여, 같은 의존성은 다음 배포 때부터 다시 받지 않도록 설정한다.

> #3 script:
> - master 브랜치에 푸쉬되었을 때 수행하는 명령어이다.
> - 여기서는 프로젝트 내부에 있는 gradlew를 통해 clean&build를 수행한다.

> #4 notifications:
> - Trvais CI 실행이 완료 되면 자동으로 지정된 메일로 알람이 가도록 설정한다.

# Travis CI와 AWS S3, CodeDeploy 연동
AWS S3와 CodeDeploy의 생성을 끝내고 프로젝트에 있는 .travis.yml 파일을 다음과 같이 수정한다.

```yml
language: java
jdk:
  - openjdk8

branches:
  only:
    - master

# Travis CI 서버의 Home
cache:
  directories:
    - '$HOME/.m2/repository'
    - '$HOME/.gradle'

script: "./gradlew clean build"

before_install:
  - chmod +x gradlew

#1
before_deploy:
  - zip -r spring-boot * #2
  - mkdir -p deploy #3
  - mv spring-boot.zip deploy/spring-boot.zip #4

#5
deploy:
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY # Travis repo settings에 설정된 값
    secret_access_key: $AWS_SECRET_KEY # Travis repo settings에 설정된 값
    bucket: spring-boot-build-2 # S3 버킷
    region: ap-nrtheast-2
    skip_cleanup: true
    acl: private # zip 파일 접근을 private으로
    #6
    local_dir: deploy # before_deploy에서 생성한 디렉토리
    wait-until-deployed: true

# CI 실행 완료 시 메일로 알람
notifications:
  email:
    recipients:
      - hungrymatt489@gmail.com

```

> #1 before_deploy
> - deploy 명령어가 실행되기 전에 수행한다.
> - CodeDeploy는 Jar 파일은 인식하지 못하므로 Jar + 기타 파일을 모아 압축해야한다.

> #2 zip -r spring-boot *
> - 해당 위치의 모든 파일을 spring-boot 이름으로 압축한다.
> - 명령어의 마지막 위치는 프로젝트의 이름이어야 한다.

> #3 mkdir -p deploy
> - Travis CI가 실행중인 위치에 deploy라는 디렉토리를 생성한다.

> #4 mv spring-boot.zip deploy/spring-boot.zip
> - spring-boot.zip 파일을 deploy/spring-boot.zip 으로 이동시킨다.

> #5 deploy
> - S3로 파입 업로드 혹은 CodeDeploy로 배포 등 `외부 서비스와 연동될 행위`들을 선언한다.

> #6 local_idr
> - before_deploy에서 생성한 deploy 디렉토리를 지정한다.
> - 해당 위치의 파일들만 S3로 전송된다.

# Reference
- [AWS CodeDeploy Agent 설치](https://docs.aws.amazon.com/ko_kr/codedeploy/latest/userguide/codedeploy-agent-operations-install-linux.html)
- 스프링 부트와 AWS로 혼자 구현하는 웹 서비스